---

title: Makefile æ ¸å¿ƒçŸ¥è¯†

date: 2026-01-17 10:00:00 +0800

categories: [linux,makefile]

tags: [linux]

layout: post  

---

## 1. è‡ªåŠ¨åŒ–å˜é‡ ğŸ¤–

ä¸ºäº†ç®€åŒ–è§„åˆ™ç¼–å†™ï¼ŒMakefile æä¾›äº†å‡ ä¸ªéå¸¸é‡è¦çš„è‡ªåŠ¨åŒ–å˜é‡ï¼š

| **å˜é‡** | **å«ä¹‰**                                             |
| -------- | ---------------------------------------------------- |
| **`$@`** | ä»£è¡¨è§„åˆ™ä¸­çš„**ç›®æ ‡æ–‡ä»¶å**ï¼ˆå†’å·å·¦ä¾§ï¼‰ã€‚             |
| **`$<`** | ä»£è¡¨è§„åˆ™ä¸­çš„**ç¬¬ä¸€ä¸ªä¾èµ–æ–‡ä»¶å**ï¼ˆå†’å·å³ä¾§ç¬¬ä¸€ä¸ªï¼‰ã€‚ |
| **`$^`** | ä»£è¡¨è§„åˆ™ä¸­**æ‰€æœ‰çš„ä¾èµ–æ–‡ä»¶åˆ—è¡¨**ï¼ˆè‡ªåŠ¨å»é‡ï¼‰ã€‚       |

## 2. æ¨¡å¼åŒ¹é…ä¸é€šé…ç¬¦ ğŸ§©

ä½¿ç”¨ `%` å¯ä»¥ç¼–å†™é€šç”¨è§„åˆ™ï¼Œé¿å…ä¸ºæ¯ä¸ªæºæ–‡ä»¶é‡å¤ä¹¦å†™ç¼–è¯‘æŒ‡ä»¤ã€‚

Makefile

```makefile
# å°†æ‰€æœ‰çš„ .c æ–‡ä»¶ç¼–è¯‘ä¸ºå¯¹åº”çš„ .o æ–‡ä»¶
%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@
```

## 3. è‡ªåŠ¨ä¾èµ–ç®¡ç† (.d æ–‡ä»¶) ğŸ”

åœ¨åµŒå…¥å¼å¼€å‘ä¸­ï¼Œå¤´æ–‡ä»¶ï¼ˆ.hï¼‰çš„å˜åŒ–ç»å¸¸è¢«å¿½è§†ã€‚é€šè¿‡ GCC çš„ `-MMD` å‚æ•°ï¼Œå¯ä»¥å®ç°è‡ªåŠ¨è¿½è¸ªä¾èµ–ã€‚

- **åŸç†**ï¼šç¼–è¯‘å™¨åœ¨ç”Ÿæˆ `.o` çš„åŒæ—¶ï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª `.d` æ–‡ä»¶è®°å½•ä¾èµ–å…³ç³»ã€‚
- **ç”¨æ³•**ï¼šä½¿ç”¨ `-include` å°†è¿™äº›ä¾èµ–åŒ…å«è¿› Makefileã€‚

Makefile

```makefile
CFLAGS += -MMD
DEPS := $(OBJS:.o=.d)
-include $(DEPS)
```

## 4. ä¼ªç›®æ ‡ (.PHONY) ğŸ­

å½“æ–‡ä»¶å¤¹ä¸­å­˜åœ¨ä¸ Makefile ç›®æ ‡åŒåçš„æ–‡ä»¶æ—¶ï¼ˆä¾‹å¦‚æœ‰åä¸º `clean` çš„æ–‡ä»¶ï¼‰ï¼Œä¼šå¯¼è‡´æŒ‡ä»¤æ— æ³•æ‰§è¡Œã€‚ä½¿ç”¨ `.PHONY` å¯ä»¥å¼ºåˆ¶æ‰§è¡Œè¯¥åŠ¨ä½œã€‚

Makefile

```makefile
.PHONY: clean

clean:
	rm -f $(TARGET) $(OBJS) $(DEPS)
```

## 5. ç»¼åˆåº”ç”¨æ¨¡æ¿ ğŸ—ï¸

ä¸€ä¸ªå…¸å‹çš„åµŒå…¥å¼åº”ç”¨å±‚ Makefile ç»“æ„ï¼š

Makefile

```makefile
# 1. å®šä¹‰å·¥å…·é“¾å’Œå‚æ•°
CC      := arm-linux-gnueabihf-gcc
CFLAGS  := -Wall -O2 -MMD
LIBS    := -lpthread
TARGET  := my_embedded_app

# 2. å®šä¹‰ç›®æ ‡æ–‡ä»¶åˆ—è¡¨
OBJS    := main.o tool.o network.o
DEPS    := $(OBJS:.o=.d)

# 3. æœ€ç»ˆé“¾æ¥è§„åˆ™
$(TARGET): $(OBJS)
	$(CC) $(CFLAGS) -o $@ $^ $(LIBS)

# 4. æ¨¡å¼è§„åˆ™
%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

# 5. åŒ…å«ä¾èµ–æ–‡ä»¶
-include $(DEPS)

# 6. æ¸…ç†æŒ‡ä»¤
clean:
	rm -f $(TARGET) $(OBJS) $(DEPS)
```